name: CloudWatch Dashboard

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Enter the production dispatch passphrase"
        required: true
        default: ""

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-cloudwatch-dashboard
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  update-dashboard:
    name: Update CloudWatch dashboard
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION != '' && vars.AWS_REGION || 'ap-south-1' }}
    steps:
      - name: Determine dashboard name
        shell: bash
        run: |
          set -euo pipefail
          default_name="${{ vars.DASHBOARD_NAME != '' && vars.DASHBOARD_NAME || 'Data' }}"
          name="$default_name"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            input_name="$(jq -r '.inputs.dashboard_name // ""' "$GITHUB_EVENT_PATH")"
            if [ -n "$input_name" ]; then
              name="$input_name"
            fi
          fi
          echo "DASHBOARD_NAME=$name" >> "$GITHUB_ENV"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve prod/stage instances and host info
        id: ec2
        env:
          # keep these if you sometimes pass instance IDs; otherwise they can be blank
          PROD_INSTANCE_ID: ${{ env.EC2_HOST_PROD }}
          STAGE_INSTANCE_ID: ${{ env.EC2_HOST_STAGE }}

          # hardcoded Name tag values
          PROD_INSTANCE_NAME: Gollector_prod
          STAGE_INSTANCE_NAME: Gollector_stage
        run: |
          set -euo pipefail
          # Helper to resolve an instance ID by ID or Name tag
          resolve_instance() {
            local id="$1" name="$2"
            if [ -n "$id" ] && [ "$id" != "null" ]; then
              echo "$id"
              return 0
            fi
            if [ -n "$name" ] && [ "$name" != "null" ]; then
              aws ec2 describe-instances \
                --filters "Name=tag:Name,Values=$name" "Name=instance-state-name,Values=running" \
                --query "Reservations[].Instances[].InstanceId" --output text
              return 0
            fi
            echo ""; return 0
          }
          
          PROD_IID=$(resolve_instance "${PROD_INSTANCE_ID:-}" "${PROD_INSTANCE_NAME:-}")
          STAGE_IID=$(resolve_instance "${STAGE_INSTANCE_ID:-}" "${STAGE_INSTANCE_NAME:-}")
          
          if [ -z "$PROD_IID" ] || [ "$PROD_IID" = "None" ]; then
            echo "Failed to resolve PROD instance (set vars.PROD_INSTANCE_ID or vars.PROD_INSTANCE_NAME)" >&2
            exit 1
          fi
          if [ -z "$STAGE_IID" ] || [ "$STAGE_IID" = "None" ]; then
            echo "Failed to resolve STAGE instance (set vars.STAGE_INSTANCE_ID or vars.STAGE_INSTANCE_NAME)" >&2
            exit 1
          fi
          
          read -r PROD_PRIVATE_IP PROD_PRIVATE_DNS <<<"$(aws ec2 describe-instances --instance-ids "$PROD_IID" --query 'Reservations[0].Instances[0].[PrivateIpAddress,PrivateDnsName]' --output text)"
          read -r STAGE_PRIVATE_IP STAGE_PRIVATE_DNS <<<"$(aws ec2 describe-instances --instance-ids "$STAGE_IID" --query 'Reservations[0].Instances[0].[PrivateIpAddress,PrivateDnsName]' --output text)"
          
          PROD_HOST_SHORT="${PROD_PRIVATE_DNS%%.*}"
          STAGE_HOST_SHORT="${STAGE_PRIVATE_DNS%%.*}"
          
          echo "prod_instance_id=$PROD_IID" >> "$GITHUB_OUTPUT"
          echo "stage_instance_id=$STAGE_IID" >> "$GITHUB_OUTPUT"
          echo "prod_ip=$PROD_PRIVATE_IP" >> "$GITHUB_OUTPUT"
          echo "stage_ip=$STAGE_PRIVATE_IP" >> "$GITHUB_OUTPUT"
          echo "prod_host=$PROD_HOST_SHORT" >> "$GITHUB_OUTPUT"
          echo "stage_host=$STAGE_HOST_SHORT" >> "$GITHUB_OUTPUT"


      - name: Build dual-env dashboard body
        run: |
          set -euo pipefail
          cp internal/metrics/CWdash.envs.json /tmp/dashboard.json
          sed -i \
            -e "s|<prod-instance-id>|${{ steps.ec2.outputs.prod_instance_id }}|g" \
            -e "s|<stage-instance-id>|${{ steps.ec2.outputs.stage_instance_id }}|g" \
            -e "s|<prod-ip>|${{ steps.ec2.outputs.prod_ip }}|g" \
            -e "s|<stage-ip>|${{ steps.ec2.outputs.stage_ip }}|g" \
            -e "s|<prod-hostname>|${{ steps.ec2.outputs.prod_host }}|g" \
            -e "s|<stage-hostname>|${{ steps.ec2.outputs.stage_host }}|g" \
            /tmp/dashboard.json

      - name: Put dashboard
        run: |
          aws cloudwatch put-dashboard \
            --dashboard-name "$DASHBOARD_NAME" \
            --dashboard-body file:///tmp/dashboard.json

      - name: Validate dashboard
        run: |
          aws cloudwatch get-dashboard --dashboard-name "$DASHBOARD_NAME" \
            --query 'DashboardValidationMessages' --output table